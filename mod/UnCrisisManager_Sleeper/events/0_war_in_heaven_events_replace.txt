namespace = war_in_heaven

############################################
############################################
#####								  #####
#####	Events for War in Heaven	  #####
#####								  #####
#####	Replaced by Crisis Manager	#####
#####								  #####
############################################
############################################

###################
###  Constants  ###
###################

### For Seeking Leader for League of Non-Aligned Powers
@CmtConstHeavenLeagueLeaderFleetPower_T1 =   10000		## 10 k
@CmtConstHeavenLeagueLeaderFleetPower_T2 =   20000
@CmtConstHeavenLeagueLeaderFleetPower_T3 =   30000
@CmtConstHeavenLeagueLeaderFleetPower_T4 =   40000
@CmtConstHeavenLeagueLeaderFleetPower_T5 =   50000
@CmtConstHeavenLeagueLeaderFleetPower_T6 =   60000
@CmtConstHeavenLeagueLeaderFleetPower_T7 =   70000
@CmtConstHeavenLeagueLeaderFleetPower_T8 =   80000
@CmtConstHeavenLeagueLeaderFleetPower_T9 =   90000
@CmtConstHeavenLeagueLeaderFleetPower_TA =  100000		## 100 k
@CmtConstHeavenLeagueLeaderFleetPower_TB =  150000
@CmtConstHeavenLeagueLeaderFleetPower_TC =  200000
@CmtConstHeavenLeagueLeaderFleetPower_TD =  300000
@CmtConstHeavenLeagueLeaderFleetPower_TE =  500000
@CmtConstHeavenLeagueLeaderFleetPower_TF = 1000000		## 1 M

# Vanilla test event occupied
country_event = {
	id = war_in_heaven.1000
	# title = OK
	# desc = OK
	is_triggered_only = yes
	# is_test_event = yes
	# trigger = { always = no }
	hide_window = yes
	immediate = {
		set_global_flag = sleepers_awake_happened
		set_global_flag = war_in_heaven_debug
		random_country = {
			limit = {
				merg_is_fallen_empire = yes
				is_gestalt = no
			}
			set_country_flag = sleepers_awake_first
			country_event = { id = fallen_empires_awakening.3 }
		}
		# War in Heaven
		random_country = {
			limit = {
				merg_is_fallen_empire = yes
				NOR = {
					is_gestalt = yes
					has_country_flag = sleepers_awake_first
				}
			}
			set_country_flag = sleepers_awake_ancient_rival
			set_timed_country_flag = { flag = timed_ancient_rival days = 3650 }
		}
	}
}

########################
###  Trigger Events  ###
########################

### Ancient (2nd) Rival awakens
country_event = {
	id = war_in_heaven.1
	hide_window = yes

	trigger = {
		has_country_flag = sleepers_awake_ancient_rival
		NOT = { has_global_flag = sleepers_awake_rival_waking }		## This Event Happens
		has_global_flag = sleepers_awake_happened
		has_leviathans = yes
		exists = event_target:CmtTargetFirstSleeper
		event_target:CmtTargetFirstSleeper = { merg_is_awakened_fe = yes }
		# any_country = {
		# 	merg_is_awakened_fe = yes
		# 	has_country_flag = sleepers_awake_first_sleeper
		# }
		CmtTriggerCandidateAncientRival = yes
	}

	mean_time_to_happen = {
		months = 60
		modifier = {
			factor = @CmtConstHeavenPreludeSpeed_4b
			OR = {
				NOT = { has_country_flag = timed_ancient_rival }
				has_global_flag = war_in_heaven_debug
				event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenPreludeSpeed value = 4 } }
			}
		}
		modifier = {
			factor = @CmtConstHeavenPreludeSpeed_1b
			event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenPreludeSpeed value = 1 } }
		}
		modifier = {
			factor = @CmtConstHeavenPreludeSpeed_3b
			event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenPreludeSpeed value = 3 } }
		}
	}

	immediate = {
		### Basic Flag Control
		set_global_flag = sleepers_awake_rival_waking
		if = {
			limit = { event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenPreludeSpeed value = 1 } } }
			set_timed_country_flag = { flag = war_in_heaven_timer days = @CmtConstHeavenPreludeSpeed_1c }
			set_timed_country_flag = { flag = war_in_heaven_timer_2 days = @CmtConstHeavenPreludeSpeed_1d }
			set_timed_country_flag = { flag = ai_no_wars days = @CmtConstHeavenPreludeSpeed_1d }
			event_target:CmtTargetFirstSleeper = { set_timed_country_flag = { flag = ai_no_wars days = @CmtConstHeavenPreludeSpeed_1d } }
			every_playable_country = {
				set_timed_country_flag = { flag = ai_no_wars days = @CmtConstHeavenPreludeSpeed_1d }
			}
		} else_if = {
			limit = { event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenPreludeSpeed value = 3 } } }
			set_timed_country_flag = { flag = war_in_heaven_timer days = @CmtConstHeavenPreludeSpeed_3c }
			set_timed_country_flag = { flag = war_in_heaven_timer_2 days = @CmtConstHeavenPreludeSpeed_3d }
			set_timed_country_flag = { flag = ai_no_wars days = @CmtConstHeavenPreludeSpeed_3d }
			event_target:CmtTargetFirstSleeper = { set_timed_country_flag = { flag = ai_no_wars days = @CmtConstHeavenPreludeSpeed_3d } }
			every_playable_country = {
				set_timed_country_flag = { flag = ai_no_wars days = @CmtConstHeavenPreludeSpeed_3d }
			}
		} else_if = {
			limit = { event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenPreludeSpeed value = 4 } } }
			set_timed_country_flag = { flag = war_in_heaven_timer days = @CmtConstHeavenPreludeSpeed_4c }
			set_timed_country_flag = { flag = war_in_heaven_timer_2 days = @CmtConstHeavenPreludeSpeed_4d }
			set_timed_country_flag = { flag = ai_no_wars days = @CmtConstHeavenPreludeSpeed_4d }
			event_target:CmtTargetFirstSleeper = { set_timed_country_flag = { flag = ai_no_wars days = @CmtConstHeavenPreludeSpeed_4d } }
			every_playable_country = {
				set_timed_country_flag = { flag = ai_no_wars days = @CmtConstHeavenPreludeSpeed_4d }
			}
		} else = {
			set_timed_country_flag = { flag = war_in_heaven_timer days = @CmtConstHeavenPreludeSpeed_2c }
			set_timed_country_flag = { flag = war_in_heaven_timer_2 days = @CmtConstHeavenPreludeSpeed_2d }
			set_timed_country_flag = { flag = ai_no_wars days = @CmtConstHeavenPreludeSpeed_2d }
			event_target:CmtTargetFirstSleeper = { set_timed_country_flag = { flag = ai_no_wars days = @CmtConstHeavenPreludeSpeed_2d } }
			every_playable_country = {
				set_timed_country_flag = { flag = ai_no_wars days = @CmtConstHeavenPreludeSpeed_2d }
			}
		}

		# Save vanilla global event target for compatibility (and text)
		if = {
			limit = { NOT = { exists = event_target:FirstSleeper } }
			event_target:CmtTargetFirstSleeper = { save_global_event_target_as = FirstSleeper }
		}

		save_global_event_target_as = SecondSleeper
		if = {
			limit = {
				OR = {
					merg_is_fallen_empire = yes
					CmtTriggerCheckSleeperFleetPower = no
				}
			}
			### Goverment Changes
			set_country_type = awakened_fallen_empire
			CmtEffectChangeAwakenerCivic = yes

			add_awakened_fallen_empire_resources = yes # Changing country type resets resources, so give them full stores

			### Initial Reinforcement
			if = {
				limit = {
					event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenIndomitableRival value = 3 } }
					CmtTriggerCheckSleeperFleetPower = no
				}
				country_event = { id = fallen_empires.13 }
			}
			country_event = { id = fallen_empires.13 }
		}
		if = {
			limit = { CmtTriggerCheckYoungsFleetPower = yes }
			country_event = { id = fallen_empires.13 }
		}
		# legacy: add_awakened_fallen_empire_fleet = yes # also some more fleet

		### Establish communications / Notification
		every_country = {
			limit = { is_default_or_fallen = yes }
			if = {
				limit = { NOT = { has_communications = root } }
				establish_communications_no_message = root
				root = { save_event_target_as = contact_empire }
				country_event = { id = action.1 }
			}
			country_event = { id = war_in_heaven.2 }
		}
		observer_event = { id = observer.75 }
	}
}

country_event = {
	id = war_in_heaven.2
	title = war_in_heaven.2.name
	desc = war_in_heaven.2.desc
	picture = GFX_evt_fallen_empire
	show_sound = event_alien_signal
	location = from
	is_triggered_only = yes
	trigger = { is_ai = no }
	immediate = {
		set_timed_country_flag = { flag = war_in_heaven_timer days = @CmtConstHeavenPreludeSpeed_3c }
	}
	option = { name = war_in_heaven.2.a }
}

### Declare The War in Heaven
country_event = {
	id = war_in_heaven.3
	hide_window = yes

	trigger = {
		has_global_flag = sleepers_awake_rival_waking			## Previous Event Happens
		NOT = { has_global_flag = war_in_heaven_started }		## This Event Happens
		has_leviathans = yes
		OR = {
			NOT = { has_country_flag = war_in_heaven_timer }	## Moratorium Term
			has_global_flag = war_in_heaven_debug
			event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenPreludeSpeed value = 4 } }
		}
		merg_is_awakened_fe = yes
		has_country_flag = sleepers_awake_ancient_rival			## We're Rival
		is_at_war = no
		CmtTriggerCheckAncientRivalFleetPower = yes

		exists = event_target:CmtTargetFirstSleeper
		event_target:CmtTargetFirstSleeper = {
			has_country_flag = sleepers_awake_first_sleeper
			merg_is_awakened_fe = yes
			NOT = { is_same_empire = root }
			CmtTriggerCheckAncientRivalFleetPower = yes
		}
	}

	mean_time_to_happen = {
		months = 12
		modifier = {
			factor = @CmtConstHeavenPreludeSpeed_4e
			OR = {
				NOT = { has_country_flag = war_in_heaven_timer_2 }
				has_global_flag = war_in_heaven_debug
				event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenPreludeSpeed value = 4 } }
			}
		}
		modifier = {
			factor = @CmtConstHeavenPreludeSpeed_1e
			event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenPreludeSpeed value = 1 } }
		}
		modifier = {
			factor = @CmtConstHeavenPreludeSpeed_3e
			event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenPreludeSpeed value = 3 } }
		}
	}

	immediate = {
		### Basic Flag Control
		set_global_flag = war_in_heaven_started
		set_global_flag = war_in_heaven_ongoing

		### Effect for 2nd Sleeper
		if = {
			limit = {
				event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenIndomitableRival value = 3 } }
				CmtTriggerCheckSleeperFleetPower = no
			}
			country_event = { id = fallen_empires.13 }
		}
		country_event = { id = fallen_empires.13 }
		if = {
			limit = { CmtTriggerCheckYoungsFleetPower = yes }
			country_event = { id = fallen_empires.13 }
		}
		remove_country_flag = ai_no_wars
		remove_country_flag = war_in_heaven_timer
		remove_country_flag = war_in_heaven_timer_2

		### Effect for 1st Sleeper
		event_target:CmtTargetFirstSleeper = {
			if = {
				limit = {
					event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenIndomitableRival value = 3 } }
					CmtTriggerCheckSleeperFleetPower = no
				}
				country_event = { id = fallen_empires.13 }
			}
			country_event = { id = fallen_empires.13 }
			if = {
				limit = { CmtTriggerCheckYoungsFleetPower = yes }
				country_event = { id = fallen_empires.13 }
			}
			remove_country_flag = ai_no_wars
		}

		## Maybe old Sleeper
		if = {
			limit = {
				exists = event_target:FirstSleeper
				NOR = {
					event_target:FirstSleeper = { is_same_empire = root }
					is_same_empire = event_target:CmtTargetFirstSleeper
					is_at_war_with = event_target:FirstSleeper
				}
			}
			declare_war = {
				target = event_target:FirstSleeper
				name = "NAME_The_War_in_Heaven"
				attacker_war_goal = "wg_war_in_heaven"
			}
		}

		### Declare War, require to subjects
		event_target:CmtTargetFirstSleeper = {
			save_global_event_target_as = FirstSleeper
			root = { CmtEffectDeclareWarInHeaven = yes }
		}
		if = {
			limit = { has_galactic_emperor = no }
			every_playable_country = {
				country_event = { id = war_in_heaven.4 }
			}
		} else = {
			every_playable_country = {
				limit = {
					is_galactic_community_member = yes
				}
				country_event = { id = war_in_heaven.7 }
			}
			every_playable_country = {
				limit = {
					is_galactic_community_member = no
				}
				country_event = { id = war_in_heaven.4 }
			}
		}
		observer_event = { id = observer.76 }
	}
}

### Required to Subjects
country_event = {
	id = war_in_heaven.4
	title = war_in_heaven.4.name
	desc = war_in_heaven.4.desc
	picture = GFX_evt_fallen_empire_awakes
	show_sound = event_alien_signal
	location = from

	is_triggered_only = yes

	option = {
		name = war_in_heaven.4.a
		trigger = {
			merg_is_default_empire = yes
			has_been_declared_crisis = no
			is_zofe_fe = no
			is_subject = no
			is_galactic_emperor = no
			NOT = {
				any_country = {
					CmtTriggerIsHeavenAFE = yes
					is_at_war_with = prev
				}
			}
		}
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				OR = {
					is_homicidal = yes
					event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenNpcSubject value = 1 } }
				}
			}
			modifier = {		## Not Has Similar Ethic -1
				factor = 0.2
				OR = {
					AND = {
						event_target:FirstSleeper = { has_ethic = ethic_fanatic_spiritualist }
						is_spiritualist = no
					}
					AND = {
						event_target:FirstSleeper = { has_ethic = ethic_fanatic_materialist }
						is_materialist = no
					}
				}
			}
			modifier = {		## Not Has Similar Ethic -2
				factor = 0.5
				OR = {
					AND = {
						event_target:FirstSleeper = { has_ethic = ethic_fanatic_xenophobe }
						NOR = {
							is_militarist = yes
							is_xenophobe = yes
						}
					}
					AND = {
						event_target:FirstSleeper = { has_ethic = ethic_fanatic_xenophile }
						NOR = {
							is_pacifist = yes
							is_xenophile = yes
						}
					}
				}
			}
			modifier = {		## Has Opposite Ethic
				factor = 0.1
				OR = {
					AND = {
						event_target:FirstSleeper = { has_ethic = ethic_fanatic_xenophobe }
						OR = {
							is_pacifist = yes
							is_xenophile = yes
						}
					}
					AND = {
						event_target:FirstSleeper = { has_ethic = ethic_fanatic_xenophile }
						OR = {
							is_militarist = yes
							is_xenophobe = yes
						}
					}
					AND = {
						event_target:FirstSleeper = { has_ethic = ethic_fanatic_materialist }
						is_spiritualist = yes
					}
					AND = {
						event_target:FirstSleeper = { has_ethic = ethic_fanatic_spiritualist }
						is_materialist = yes
					}
				}
			}
		}
		join_war = event_target:FirstSleeper
		if = {
			limit = { is_zofe_ae = yes }		## For ZoFE
			every_subject = {
				limit = { merg_is_default_empire = yes }
				join_war = root
			}
		} else = {
			if = {
				limit = {
					event_target:FirstSleeper = { has_ethic = ethic_fanatic_xenophobe }
				}
				custom_tooltip = war_in_heaven.4.a.thrall.tt
				hidden_effect = {
					set_subject_of = {
						who = event_target:FirstSleeper
						preset = preset_thrall
					}
				}
			} else_if = {
				limit = {
					event_target:FirstSleeper = { has_ethic = ethic_fanatic_xenophile }
				}
				custom_tooltip = war_in_heaven.4.a.signatory.tt
				hidden_effect = {
					set_subject_of = {
						who = event_target:FirstSleeper
						preset = preset_signatory
					}
				}
			} else_if = {
				limit = {
					event_target:FirstSleeper = { has_ethic = ethic_fanatic_spiritualist }
				}
				custom_tooltip = war_in_heaven.4.a.dominion.tt
				hidden_effect = {
					set_subject_of = {
						who = event_target:FirstSleeper
						preset = preset_dominion
					}
					if = { limit = { is_gestalt = no }
						shift_ethic = ethic_fanatic_spiritualist
					}
				}
			} else_if = {
				limit = {
					event_target:FirstSleeper = { has_ethic = ethic_fanatic_materialist }
				}
				custom_tooltip = war_in_heaven.4.a.satellite.tt
				hidden_effect = {
					set_subject_of = {
						who = event_target:FirstSleeper
						preset = preset_satellite
					}
				}
			}
		}

		hidden_effect = {
			set_country_flag = war_in_heaven_picked_side
			add_opinion_modifier = { who = event_target:FirstSleeper modifier = opinion_war_in_heaven_ally }
			event_target:FirstSleeper = { add_opinion_modifier = { who = root modifier = opinion_war_in_heaven_ally } }
			add_opinion_modifier = { who = from modifier = opinion_war_in_heaven_enemy }
			from = { add_opinion_modifier = { who = root modifier = opinion_war_in_heaven_enemy } }
		}
	}
	option = {
		name = war_in_heaven.4.b
		trigger = {
			merg_is_default_empire = yes
			has_been_declared_crisis = no
			is_zofe_fe = no
			is_subject = no
			is_galactic_emperor = no
			NOT = {
				any_country = {
					CmtTriggerIsHeavenAFE = yes
					is_at_war_with = prev
				}
			}
		}
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				OR = {
					is_homicidal = yes
					event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenNpcSubject value = 1 } }
				}
			}
			modifier = {		## Not Has Similar Ethic -1
				factor = 0.2
				OR = {
					AND = {
						from = { has_ethic = ethic_fanatic_spiritualist }
						is_spiritualist = no
					}
					AND = {
						from = { has_ethic = ethic_fanatic_materialist }
						is_materialist = no
					}
				}
			}
			modifier = {		## Not Has Similar Ethic -2
				factor = 0.5
				OR = {
					AND = {
						from = { has_ethic = ethic_fanatic_xenophobe }
						NOR = {
							is_militarist = yes
							is_xenophobe = yes
						}
					}
					AND = {
						from = { has_ethic = ethic_fanatic_xenophile }
						NOR = {
							is_pacifist = yes
							is_xenophile = yes
						}
					}
				}
			}
			modifier = {		## Has Opposite Ethic
				factor = 0.1
				OR = {
					AND = {
						from = { has_ethic = ethic_fanatic_xenophobe }
						OR = {
							is_pacifist = yes
							is_xenophile = yes
						}
					}
					AND = {
						from = { has_ethic = ethic_fanatic_xenophile }
						OR = {
							is_militarist = yes
							is_xenophobe = yes
						}
					}
					AND = {
						from = { has_ethic = ethic_fanatic_materialist }
						is_spiritualist = yes
					}
					AND = {
						from = { has_ethic = ethic_fanatic_spiritualist }
						is_materialist = yes
					}
				}
			}
		}
		join_war = from
		if = {
			limit = { is_zofe_ae = yes }		## For ZoFE
			every_subject = {
				limit = { merg_is_default_empire = yes }
				join_war = root
			}
		} else = {
			if = {
				limit = {
					from = { has_ethic = ethic_fanatic_xenophobe }
				}
				custom_tooltip = war_in_heaven.4.b.thrall.tt
				hidden_effect = {
					set_subject_of = {
						who = from
						preset = preset_thrall
					}
				}
			} else_if = {
				limit = {
					from = { has_ethic = ethic_fanatic_xenophile }
				}
				custom_tooltip = war_in_heaven.4.b.signatory.tt
				hidden_effect = {
					set_subject_of = {
						who = from
						preset = preset_signatory
					}
				}
			} else_if = {
				limit = {
					from = { has_ethic = ethic_fanatic_spiritualist }
				}
				custom_tooltip = war_in_heaven.4.b.dominion.tt
				hidden_effect = {
					set_subject_of = {
						who = from
						preset = preset_dominion
					}
					if = { limit = { is_gestalt = no }
						shift_ethic = ethic_fanatic_spiritualist
					}
				}
			} else_if = {
				limit = {
					from = { has_ethic = ethic_fanatic_materialist }
				}
				custom_tooltip = war_in_heaven.4.b.satellite.tt
				hidden_effect = {
					set_subject_of = {
						who = from
						preset = preset_satellite
					}
				}
			}
		}
		hidden_effect = {
			set_country_flag = war_in_heaven_picked_side
			add_opinion_modifier = { who = from modifier = opinion_war_in_heaven_ally }
			from = { add_opinion_modifier = { who = root modifier = opinion_war_in_heaven_ally } }
			add_opinion_modifier = { who = event_target:FirstSleeper modifier = opinion_war_in_heaven_enemy }
			event_target:FirstSleeper = { add_opinion_modifier = { who = root modifier = opinion_war_in_heaven_enemy } }
		}
	}
	option = {
		name = war_in_heaven.4.c
		trigger = {
			is_subject = no
			has_been_declared_crisis = no
		}
		ai_chance = {
			factor = 40
			modifier = { factor = 0.5 fleet_power < 25000 }
			modifier = { factor = 0.5 fleet_power < 50000 }
			modifier = { factor = 2 fleet_power > 80000 }
			modifier = { factor = 2 fleet_power > 10000 }
			modifier = { factor = 2 fleet_power > 125000 }
			modifier = { factor = 5 has_federation = yes }
			modifier = {
				factor = 3
				any_country = {
					is_in_federation_with = root
					fleet_power > 100000
				}
			}
			modifier = {
				factor = 2
				any_playable_country = {
					is_ai = no
					is_in_federation_with = root
				}
			}
			modifier = {
				factor = @CmtConstHeavenNpcSubject_2a
				event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenNpcSubject value = 2 } }
			}
			modifier = {
				factor = @CmtConstHeavenNpcSubject_4a
				event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenNpcSubject value = 4 } }
			}
			modifier = {
				factor = 0
				event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenNpcSubject value = 5 } }
			}
		}
	}

	option = {
		name = war_in_heaven.4.c.2
		trigger = { is_subject = no }
		ai_chance = { factor = 0 }
	}

	option = {
		name = war_in_heaven.4.d
		trigger = { is_subject = yes overlord = { merg_is_awakened_fe = yes } }
		if = {
			limit = { overlord = { is_same_empire = event_target:FirstSleeper } }
			join_war = event_target:FirstSleeper
		} else_if = {
			limit = { overlord = { is_same_empire = from } }
			join_war = from
		}
	}

	option = {		## For ZoFE
		name = war_in_heaven.4.e
		trigger = { is_zofe_ae = yes }
		ai_chance = {
			factor = 100
			modifier = { factor = 0.5 fleet_power < 25000 }
			modifier = { factor = 0.5 fleet_power < 50000 }
			modifier = { factor = 2 fleet_power > 80000 }
			modifier = { factor = 2 fleet_power > 100000 }
			modifier = { factor = 2 fleet_power > 125000 }
		}
		hidden_effect = {
			add_opinion_modifier = { who = from modifier = opinion_war_in_heaven_enemy }
			from = { add_opinion_modifier = { who = root modifier = opinion_war_in_heaven_enemy } }
			add_opinion_modifier = { who = event_target:FirstSleeper modifier = opinion_war_in_heaven_enemy }
			event_target:FirstSleeper = { add_opinion_modifier = { who = root modifier = opinion_war_in_heaven_enemy } }
		}
		declare_war = {
			target = event_target:FirstSleeper
			name = "NAME_The_War_in_Heaven"
			attacker_war_goal = "wg_war_in_heaven"
		}
		declare_war = {
			target = from
			name = "NAME_The_War_in_Heaven"
			attacker_war_goal = "wg_war_in_heaven"
		}
		if = {
			limit = {
				exists = event_target:CmtTargetFirstSleeper
				event_target:CmtTargetFirstSleeper = { NOT = { is_same_empire = event_target:FirstSleeper } }
				NOT = { is_at_war_with = event_target:CmtTargetFirstSleeper }
			}
			declare_war = {
				target = event_target:CmtTargetFirstSleeper
				name = "NAME_The_War_in_Heaven"
				attacker_war_goal = "wg_war_in_heaven"
			}
		}

		every_subject = {
			limit = { merg_is_default_empire = yes }
			join_war = root
		}
	}

	option = {
		name = war_in_heaven.4.f
		trigger = { is_zofe_fe = yes }
		ai_chance = { factor = 500 }
	}
}

############################
###  Non-Aligned League  ###
############################

### Find Leader for League
country_event = {
	id = war_in_heaven.12
	hide_window = yes

	trigger = {
		merg_is_awakened_fe = yes
		has_country_flag = sleepers_awake_first_sleeper
		has_global_flag = war_in_heaven_ongoing			## Previous Event Happens
		NOR = {
			# has_global_flag = CmtFlagHeavenGiveUpLeague
			has_global_flag = war_in_heaven_nonaligned_league		## Leader Chosen
			has_global_flag = war_in_heaven_seeking_league_leader	## Now Ordering
		}
		has_galactic_emperor = no # Galactic Empire serves this purpose
	}

	mean_time_to_happen = {
		days = 30
		modifier = {
			factor = @CmtConstHeavenPreludeSpeed_4f
			OR = {
				has_global_flag = war_in_heaven_debug
				event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenPreludeSpeed value = 4 } }
			}
		}
		modifier = {
			factor = @CmtConstHeavenPreludeSpeed_1f
			event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenPreludeSpeed value = 1 } }
		}
		modifier = {
			factor = @CmtConstHeavenPreludeSpeed_3f
			event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenPreludeSpeed value = 3 } }
		}
	}

	immediate = {
		## Custodian is asked first, if one exists
		if = {
			limit = {
				has_galactic_custodian = yes
				any_playable_country = {
					is_galactic_custodian = yes
					NOR = {
						has_country_flag = war_in_heaven_league_leader_declined
						any_country = {
							merg_is_awakened_fe = yes
							is_at_war_with = prev
						}
					}
				}
			}
			random_playable_country = {
				limit = {
					is_galactic_custodian = yes
					NOR = {
						has_country_flag = war_in_heaven_league_leader_declined
						any_country = {
							merg_is_awakened_fe = yes
							is_at_war_with = prev
						}
					}
				}
				set_global_flag = war_in_heaven_seeking_league_leader
				country_event = { id = war_in_heaven.13 }
			}
		}
		### Search for federation leaders; offer leadership to strongest one that hasn't declined (if any)
		# Find strongest neutral power and offer them to become league leader
		# First federation leaders are asked, then simply the strongest country
		else_if = {
			limit = {
				# NOT = { has_global_flag = war_in_heaven_seeking_league_leader }
				any_federation = {
					any_member = {
						is_federation_leader = yes
						is_homicidal = no
						has_been_declared_crisis = no
						NOR = {
							has_country_flag = war_in_heaven_league_leader_declined
							any_country = {
								merg_is_awakened_fe = yes
								is_at_war_with = prev
							}
						}
					}
					NOT = {
						any_federation = {
							NOT = { is_same_value = prev }
							relative_power = {
								who = prev
								value > equivalent
								category = fleet
							}
							any_member = {
								is_federation_leader = yes
								is_homicidal = no
								has_been_declared_crisis = no
								NOR = {
									has_country_flag = war_in_heaven_league_leader_declined
									any_country = {
										merg_is_awakened_fe = yes
										is_at_war_with = prev
									}
								}
							}
						}
					}
				}
			}
			random_federation = {
				limit = {
					any_member = {
						is_federation_leader = yes
						is_homicidal = no
						has_been_declared_crisis = no
						NOR = {
							has_country_flag = war_in_heaven_league_leader_declined
							any_country = {
								merg_is_awakened_fe = yes
								is_at_war_with = prev
							}
						}
					}
					NOT = {
						any_federation = {
							NOT = { is_same_value = prev }
							relative_power = {
								who = prev
								value > equivalent
								category = fleet
							}
							any_member = {
								is_federation_leader = yes
								is_homicidal = no
								has_been_declared_crisis = no
								NOR = {
									has_country_flag = war_in_heaven_league_leader_declined
									any_country = {
										merg_is_awakened_fe = yes
										is_at_war_with = prev
									}
								}
							}
						}
					}
				}
				random_member = {
					limit = {
						is_federation_leader = yes
						is_homicidal = no
						has_been_declared_crisis = no
						NOR = {
							has_country_flag = war_in_heaven_league_leader_declined
							any_country = {
								merg_is_awakened_fe = yes
								is_at_war_with = prev
							}
						}
					}
					set_global_flag = war_in_heaven_seeking_league_leader
					country_event = { id = war_in_heaven.13 }
				}
			}
		}
		### Otherwise, make a list of neutral powers and search for strongest member to offer leadership
		else = {
			## Nominate Potential Leaders/Members (Pre-Process)
			# set_variable = { which = CmtFlagNominatedLeader value = 0 }
			every_playable_country = {
				limit = {
					is_subject = no
					has_been_declared_crisis = no
					NOR = {
						has_country_flag = war_in_heaven_league_leader_declined
						has_ascension_perk = ap_become_the_crisis
						is_homicidal = yes
						any_country = {
							CmtTriggerIsHeavenAFE = yes
							is_at_war_with = prev
						}
					}
				}
				prev = { change_variable = { which = CmtFlagNominatedLeader value = 1 } }
				set_timed_country_flag = { flag = CmtFlagNominatedLeader days = 3 }
			}

			## If there are fewer than 2 nominees, give up on forming league.
			if = {
				limit = {
					NOR = {
						event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenNpcLeague value = 1 } }
						check_variable = { which = CmtFlagNominatedLeader value < 2 }
						count_country = {
							limit = {
								has_country_flag = CmtFlagNominatedLeader
								has_been_declared_crisis = no
							}
							count < 2
						}
					}
				}
				### Pick most powerful nominee & offer leadership.
				random_playable_country = {
					limit = {
						has_country_flag = CmtFlagNominatedLeader
						has_been_declared_crisis = no
						NOT = {
							any_playable_country = {
								has_country_flag = CmtFlagNominatedLeader
								has_been_declared_crisis = no
								relative_power = {
									who = prev
									value > equivalent
								}
							}
						}
					}
					set_global_flag = war_in_heaven_seeking_league_leader
					country_event = { id = war_in_heaven.13 }
				}
			} else = {
				event_target:CmtGlobalVar = { set_variable = { which = CmtVarHeavenPreludeSpeed value = 1 } }
			}
			clear_variable = CmtFlagNominatedLeader
		}
	}
}

### Order Leader for League
country_event = {
	id = war_in_heaven.13
	title = war_in_heaven.13.name
	desc = {
		text = war_in_heaven.13.desc
		trigger = {
			is_galactic_custodian = no
			OR = {
				has_federation = no
				is_federation_leader = no
			}
		}
	}
	desc = {
		text = war_in_heaven.13.desc2
		trigger = {
			is_galactic_custodian = no
			has_federation = yes
			is_federation_leader = yes
		}
	}
	desc = {
		text = war_in_heaven.13.desc3
		trigger = { is_galactic_custodian = yes }
	}
	picture = GFX_evt_fallen_empire_awakes
	show_sound = event_alien_signal
	location = root

	is_triggered_only = yes

	trigger = {
		has_been_declared_crisis = no
		NOT = { event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenNpcLeague value = 1 } } }
	}
	immediate = { set_country_flag = war_in_heaven_nonaligned_league_check }

	# League leadership acceptance
	option = {
		name = war_in_heaven.13.a
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				is_homicidal = yes
				NOT = { event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenNpcLeague value = 5 } } }
			}
			modifier = {
				factor = @CmtConstHeavenNpcLeague_2a
				event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenNpcLeague value = 2 } }
			}
			modifier = {
				factor = @CmtConstHeavenNpcLeague_3a
				event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenNpcLeague value = 3 } }
			}
			modifier = { factor = @CmtConstHeavenLeaguePersonality_5 CmtTriggerHeavenLeagueNPCweight5 = yes }
			modifier = { factor = @CmtConstHeavenLeaguePersonality_4 CmtTriggerHeavenLeagueNPCweight4 = yes }
			modifier = { factor = @CmtConstHeavenLeaguePersonality_2 CmtTriggerHeavenLeagueNPCweight2 = yes }
			modifier = { factor = @CmtConstHeavenLeaguePersonality_1 CmtTriggerHeavenLeagueNPCweight1 = yes }
			modifier = { factor = 2 fleet_power < 10000 }
			modifier = { factor = 1.5 fleet_power < 20000 }
			modifier = { factor = 1.5 fleet_power < 40000 }
			modifier = { factor = 1.5 fleet_power < 60000 }
		}
		# If a fed leader accepts, turn that fed into the League
		if = {
			limit = {
				has_federation = yes
				is_federation_leader = yes
			}
			federation = {
			 	set_name = NAME_League_of_Non-Aligned_Powers
				set_federation_flag = non_aligned_league
				if = {
					limit = { NOT = { has_federation_type = military_federation } has_federations_dlc = yes }
					set_federation_type = military_federation
				}
			}
			hidden_effect = {
				set_country_flag = formed_nonaligned_league
				every_country = {
					limit = {
						is_ai = yes
						is_in_federation_with = root
						NOT = { is_same_empire = root }
					}
					set_country_flag = war_in_heaven_nonaligned_league_check
					add_non_aligned_league_opinions = yes
					set_timed_country_flag = { flag = ai_no_leave_fed years = 20 }
				}
			}
		}
		# If a fed member accepts, they leave their fed to form League
		else_if = {
			limit = { has_federation = yes }
			leave_alliance = { override_requirements = yes }
		}
		hidden_effect = {
			set_timed_country_flag = { flag = war_in_heaven_nonaligned_league_timer months = 6 }
			set_country_flag = war_in_heaven_league_leader
			set_global_flag = war_in_heaven_nonaligned_league

			# User-picked delays on fed membership evaluation
			if = {
				limit = { event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenPreludeSpeed value = 1 } } }
				set_timed_country_flag = { flag = war_in_heaven_nonaligned_league_timer days = @CmtConstHeavenPreludeSpeed_1g }
				every_country = { country_event = { id = war_in_heaven.14 days = 1 random = @CmtConstHeavenPreludeSpeed_1g } }
			} else_if = {
				limit = { event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenPreludeSpeed value = 3 } } }
				set_timed_country_flag = { flag = war_in_heaven_nonaligned_league_timer days = @CmtConstHeavenPreludeSpeed_3g }
				every_country = { country_event = { id = war_in_heaven.14 days = 1 random = @CmtConstHeavenPreludeSpeed_3g } }
			} else_if = {
				limit = { event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenPreludeSpeed value = 4 } } }
				set_timed_country_flag = { flag = war_in_heaven_nonaligned_league_timer days = @CmtConstHeavenPreludeSpeed_4g }
				every_country = { country_event = { id = war_in_heaven.14 days = 1 random = @CmtConstHeavenPreludeSpeed_4g } }
			} else = {
				set_timed_country_flag = { flag = war_in_heaven_nonaligned_league_timer days = @CmtConstHeavenPreludeSpeed_2g }
				every_country = { country_event = { id = war_in_heaven.14 days = 1 random = @CmtConstHeavenPreludeSpeed_2g } }
			}

			# Awakened empires don't like League leader
			every_country = {
				limit = { CmtTriggerIsHeavenAFE = yes }
				add_opinion_modifier = { who = from modifier = opinion_non_aligned_league_fe }
				from = { add_opinion_modifier = { who = root modifier = opinion_non_aligned_league_fe } }
			}

			# Give other countries ___
			every_playable_country = {
				limit = {
					NOR = {
						is_ai = yes
						has_country_flag = war_in_heaven_nonaligned_league_check
						is_same_empire = root
					}
				}
				if = {
					limit = {
						OR = {
							is_subject = no
							is_in_federation_with = root
						}
						is_homicidal = no
					}
					country_event = { id = war_in_heaven.19 }
				} else = { country_event = { id = war_in_heaven.22 } }
			}
		}
	}

	# League leadership declined
	option = {
		name = war_in_heaven.13.b
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				OR = {
					event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenNpcLeague value = 5 } }
					NOR = {
						event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenNpcLeague value = 2 } }
						event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenNpcLeague value = 3 } }
						is_homicidal = yes
					}
				}
			}
		}
		hidden_effect = { set_country_flag = war_in_heaven_league_leader_declined }
	}

	after = {
		hidden_effect = { remove_global_flag = war_in_heaven_seeking_league_leader }
	}
}

### AI Evaluates Joining League
country_event = {
	id = war_in_heaven.14
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		merg_is_default_empire = yes
		is_ai = yes
		is_subject = no
		NOR = {
			has_country_flag = war_in_heaven_nonaligned_league_check		## Declines Already (Leader Event or This One)
			any_country = {
				merg_is_awakened_fe = yes
				is_at_war_with = prev
			}
			# any_country = {
			# 	has_federation = yes
			# 	alliance = { has_federation_flag = non_aligned_league }
			# 	is_at_war_with = prev
			# }
			event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenNpcLeague value = 1 } }
		}
		# is_homicidal = no
		any_playable_country = {
			has_country_flag = war_in_heaven_league_leader
			# has_country_flag = war_in_heaven_nonaligned_league_timer
			# OR = {
			# 	has_federation = yes
			# 	NOT = { has_country_flag = formed_nonaligned_league }
			# }
			is_subject = no
			NOT = { is_in_federation_with = root }
		}
	}

	immediate = {
		set_country_flag = war_in_heaven_nonaligned_league_check
		random_list = {
			100 = {
				modifier = {
					factor = 0
					is_homicidal = yes
					NOT = { event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenNpcLeague value = 5 } } }
				}
				modifier = {
					factor = @CmtConstHeavenNpcLeague_2b
					event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenNpcLeague value = 2 } }
				}
				modifier = {
					factor = @CmtConstHeavenNpcLeague_3b
					event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenNpcLeague value = 3 } }
				}
				modifier = { factor = @CmtConstHeavenLeaguePersonality_5 CmtTriggerHeavenLeagueNPCweight5 = yes }
				modifier = { factor = @CmtConstHeavenLeaguePersonality_4 CmtTriggerHeavenLeagueNPCweight4 = yes }
				modifier = { factor = @CmtConstHeavenLeaguePersonality_2 CmtTriggerHeavenLeagueNPCweight2 = yes }
				modifier = { factor = @CmtConstHeavenLeaguePersonality_1 CmtTriggerHeavenLeagueNPCweight1 = yes }
				modifier = { factor = 2 fleet_power < 10000 }
				modifier = { factor = 1.5 fleet_power < 20000 }
				modifier = { factor = 1.5 fleet_power < 40000 }
				modifier = { factor = 1.5 fleet_power < 60000 }

				random_playable_country = {
					limit = {
						has_country_flag = war_in_heaven_league_leader
						is_subject = no
					}
					country_event = { id = war_in_heaven.15 }
				}
			}
			100 = {
				modifier = {
					factor = 0
					OR = {
						root = { has_rival = prev }
						event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenNpcLeague value = 5 } }
						NOR = {
							event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenNpcLeague value = 2 } }
							event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenNpcLeague value = 3 } }
						}
						is_homicidal = no
					}
				}
				### Do Nothing
			}
		}
	}
}

### Requested to Join to League
country_event = {
	id = war_in_heaven.15
	title = war_in_heaven.15.name
	desc = war_in_heaven.15.desc
	picture = GFX_evt_fallen_empire_awakes
	show_sound = event_alien_signal
	location = from

	is_triggered_only = yes

	trigger = {
		OR = {
			has_federation = yes
			NOT = { has_country_flag = formed_nonaligned_league }
		}
	}

	# Leader accepts League-join request
	option = {
		name = war_in_heaven.15.a
		ai_chance = { factor = 100 }
		hidden_effect = {
			if = {
				limit = { NOT = { has_country_flag = formed_nonaligned_league } }
				set_country_flag = formed_nonaligned_league
			}
			from = {
				if = {
					limit = { has_federation = yes }
					leave_alliance = { override_requirements = yes }
				}
				add_non_aligned_league_opinions = yes
				if = {
					limit = { is_ai = no }
					country_event = { id = war_in_heaven.20 }
				}
			}

			# If it's the first request and leader has no federation, then federate
			if = {
				limit = { has_federation = no }
				from = {
					set_timed_country_flag = { flag = ai_no_leave_fed years = 20 }
					join_alliance = {
						who = root
						name = NAME_League_of_Non-Aligned_Powers
						override_requirements = yes
					}
					hidden_effect = {
						if = { # end non-federation-sanctioned wars
							limit = { is_at_war = yes }
							every_war = { remove_war_participant = prev }
							every_subject = { every_war = { remove_war_participant = prev } }
						}
						root.federation = {
							set_federation_flag = non_aligned_league
							if = { limit = { has_federations_dlc = yes }
								set_federation_type = military_federation
							}
							if = {
								limit = { has_federation_perk = cohesion_join_1 }
								add_cohesion = 50
							} else = { add_cohesion = 100 }
							add_federation_experience = 4200 # level 3 with some breathing room
						}
					}
				}
			}

			# If a federation exists, do things based on the fed's rules
			else = {
				from = {
					set_timed_country_flag = { flag = ai_no_leave_fed years = 20 }
					hidden_effect = { # end rivalries, wars
						if = {
							limit = {
								any_rival_country = {
									has_federation = yes
									federation = { is_same_value = root.federation }
								}
							}
							every_rival_country = {
								limit = {
									has_federation = yes
									federation = { is_same_value = root.federation }
								}
								prev = { end_rivalry = prev }
							}
						}
						root.federation = {
							if = {
								limit = {
									any_member = { is_rival = prevprev }
								}
								every_member = {
									limit = { is_rival = prevprev }
									end_rivalry = prevprev
								}
							}
						}
						if = {
							limit = { is_at_war = yes }
							every_war = { remove_war_participant = prev }
						}
					}
					join_alliance = {
						who = root
						override_requirements = yes
					}
					hidden_effect = {
						# counteract the -100 cohesion you'd normally get for new members
						root.federation = {
							if = { limit = { has_federation_perk = cohesion_join_1 }
								add_cohesion = 50
							} else = { add_cohesion = 100 }
							add_federation_experience = 150
						}
					}
					if = {
						limit = {
							is_overlord = yes
							root.federation = { has_federation_law = allow_subjects_to_join_yes }
						}
						every_subject = {
							root = {
								prev = { add_non_aligned_league_opinions = yes }
							}
							join_alliance = {
								who = root
								override_requirements = yes
							}
							hidden_effect = {
								root.federation = {
									add_cohesion = 100
									add_federation_experience = 100
								}
							}
						}
					}
				}
			}
		}
	}

	# Leader rejects League-join request
	option = {
		name = war_in_heaven.15.b
		ai_chance = {
			factor = 1
			modifier = { factor = 200 has_rival = from }
			modifier = { factor = 0.5 is_xenophile = yes }
			modifier = { factor = 0.5 is_militarist = yes }
		}
		hidden_effect = {
			from = {
				add_opinion_modifier = { who = root modifier = opinion_non_aligned_league_declined }
				if = {
					limit = { is_ai = no }
					country_event = { id = war_in_heaven.21 }
				}
			}
		}
	}
}

### Declare War (League vs. Ancient)
country_event = {
	id = war_in_heaven.16
	title = war_in_heaven.16.name
	desc = war_in_heaven.16.desc
	picture = GFX_evt_fallen_empire_awakes
	show_sound = event_alien_signal
	location = root

	trigger = {
		has_global_flag = war_in_heaven_nonaligned_league	## Previous Event
		has_federation = yes
		federation = { has_federation_flag = non_aligned_league }
		OR = {
			is_federation_leader = yes
			has_country_flag = war_in_heaven_league_leader
		}
		has_been_declared_crisis = no
		# merg_is_default_empire = yes
		# is_subject = no
		NOR = {
			has_global_flag = war_in_heaven_nonaligned_league_war		## This Event
			has_country_flag = war_in_heaven_nonaligned_league_timer	## Control Min. Term
			any_country = {
				CmtTriggerIsHeavenAFE = yes
				is_at_war_with = prev
			}
		}
		# count_country = {
		# 	count = 2
		# 	CmtTriggerIsHeavenAFE = yes
		# }
		any_country = {
			merg_is_awakened_fe = yes
			has_country_flag = sleepers_awake_first_sleeper
		}
		any_country = {
			merg_is_awakened_fe = yes
			has_country_flag = sleepers_awake_ancient_rival
		}
	}

	mean_time_to_happen = {
		days = 90
		modifier = {
			factor = @CmtConstHeavenPreludeSpeed_4h
			OR = {
				has_global_flag = war_in_heaven_debug
				event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenPreludeSpeed value = 4 } }
			}
		}
		modifier = {
			factor = @CmtConstHeavenPreludeSpeed_1h
			event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenPreludeSpeed value = 1 } }
		}
		modifier = {
			factor = @CmtConstHeavenPreludeSpeed_3h
			event_target:CmtGlobalVar = { check_variable = { which = CmtVarHeavenPreludeSpeed value = 3 } }
		}
	}

	immediate = {
		set_global_flag = war_in_heaven_nonaligned_league_war

		random_country = {
			limit = {
				merg_is_awakened_fe = yes
				has_country_flag = sleepers_awake_first_sleeper
			}
			# Save vanilla global event targets for compatibility
			# save_event_target_as = FirstSleeper
			save_global_event_target_as = FirstSleeper
		}
		random_country = {
			limit = {
				merg_is_awakened_fe = yes
				has_country_flag = sleepers_awake_ancient_rival
			}
			# Save vanilla global event targets for compatibility
			save_event_target_as = SecondSleeper
			save_global_event_target_as = SecondSleeper
		}
	}

	option = {
		name = war_in_heaven.16.a
		every_country = {
			limit = { CmtTriggerIsHeavenAFE = yes }
			root = { CmtEffectDeclareWarInHeaven = yes }
			hidden_effect = { every_subject = { join_war = prev } }
		}
	}
}

##########################
###  Post War Process  ###
##########################

# War in Heaven combatant defeated by nonaligned league
# This = destroyed country
# From = optional, destroyer (country)
country_event = {
	id = war_in_heaven.10
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		CmtTriggerIsHeavenAFE = yes
		has_global_flag = war_in_heaven_ongoing
		NAND = {
			exists = from
			from = { CmtTriggerIsHeavenAFE = yes }
		}
		any_war = {
			any_war_participant = {
				prev = {
					OR = {
						using_war_goal = { type = wg_war_in_heaven owner = prev }
						using_war_goal = { type = wg_CmtWarInHeaven1 owner = prev }
						using_war_goal = { type = wg_CmtWarInHeaven3 owner = prev }
						using_war_goal = { type = wg_CmtWarInHeaven4 owner = prev }
						using_war_goal = { type = wg_CmtWarInHeaven5 owner = prev }
					}
				}
			}
			any_war_participant = {
				merg_is_awakened_fe = yes
				prev = {
					OR = {
						AND = {
							is_war_participant = { who = prev side = attackers }
							is_war_participant = { who = root side = defenders }
						}
						AND = {
							is_war_participant = { who = prev side = defenders }
							is_war_participant = { who = root side = attackers }
						}
					}
				}
			}
		}
	}

	immediate = {
		set_global_flag = war_in_heaven_first_awakened_down
		random_country = {
			limit = {
				CmtTriggerIsHeavenAFE = yes
				NOT = { is_same_empire = root }
				any_war = {
					any_war_participant = {
						prev = {
							OR = {
								using_war_goal = { type = wg_war_in_heaven owner = prev }
								using_war_goal = { type = wg_CmtWarInHeaven1 owner = prev }
								using_war_goal = { type = wg_CmtWarInHeaven3 owner = prev }
								using_war_goal = { type = wg_CmtWarInHeaven4 owner = prev }
								using_war_goal = { type = wg_CmtWarInHeaven5 owner = prev }
							}
						}
					}
				}
			}
			save_event_target_as = RemainingAwakened
		}
		# End War in Heaven
		every_war = {
			limit = {
				any_war_participant = {
					prev = {
						OR = {
							using_war_goal = { type = wg_war_in_heaven owner = prev }
							using_war_goal = { type = wg_CmtWarInHeaven1 owner = prev }
							using_war_goal = { type = wg_CmtWarInHeaven3 owner = prev }
							using_war_goal = { type = wg_CmtWarInHeaven4 owner = prev }
							using_war_goal = { type = wg_CmtWarInHeaven5 owner = prev }
						}
					}
				}
			}
			# end_war_effect = yes
			every_war_participant = {
				limit = { NOT = { is_same_empire = root } } # don't break the loop
				prev = { remove_war_participant = prev }
			}
		}
		# Conduct War in Heaven cleanup
		if = {
			limit = {
				NOT = {
					any_country = {
						any_war = {
							OR = {
								using_war_goal = { type = wg_war_in_heaven owner = prev }
								using_war_goal = { type = wg_CmtWarInHeaven1 owner = prev }
								using_war_goal = { type = wg_CmtWarInHeaven3 owner = prev }
								using_war_goal = { type = wg_CmtWarInHeaven4 owner = prev }
								using_war_goal = { type = wg_CmtWarInHeaven5 owner = prev }
							}
						}
					}
				}
			}
			remove_global_flag = war_in_heaven_ongoing
			set_global_flag = war_in_heaven_ended
			# for reuse
			remove_country_flag = sleepers_awake_first_sleeper
			remove_country_flag = sleepers_awake_ancient_rival
			remove_country_flag = war_in_heaven_timer
		}
		every_playable_country = {
			limit = { is_ai = no }
			country_event = { id = war_in_heaven.11 }
		}
		observer_event = { id = observer.79 }
	}
}

### War in Heaven Ends because of Both Ancients Gone (on_country_destroyed)
country_event = {
	id = war_in_heaven.17
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		CmtTriggerIsHeavenAFE = yes
		has_global_flag = war_in_heaven_ongoing
		NOT = {
			any_country = {
				CmtTriggerIsHeavenAFE = yes
				is_at_war_with = root
			}
		}
	}

	immediate = {
		# Force-end War in Heaven if it's still running
		if = {
			limit = {
				any_war = {
					is_total_war = yes
					any_war_participant = {
						prev = {
							OR = {
								using_war_goal = { type = wg_war_in_heaven owner = prev }
								using_war_goal = { type = wg_CmtWarInHeaven1 owner = prev }
								using_war_goal = { type = wg_CmtWarInHeaven3 owner = prev }
								using_war_goal = { type = wg_CmtWarInHeaven4 owner = prev }
								using_war_goal = { type = wg_CmtWarInHeaven5 owner = prev }
							}
						}
					}
				}
			}

			random_country = {
				limit = {
					CmtTriggerIsHeavenAFE = yes
					NOT = { is_same_empire = root }
					any_war = {
						is_total_war = yes
						any_war_participant = {
							prev = {
								OR = {
									using_war_goal = { type = wg_war_in_heaven owner = prev }
									using_war_goal = { type = wg_CmtWarInHeaven1 owner = prev }
									using_war_goal = { type = wg_CmtWarInHeaven3 owner = prev }
									using_war_goal = { type = wg_CmtWarInHeaven4 owner = prev }
									using_war_goal = { type = wg_CmtWarInHeaven5 owner = prev }
								}
							}
						}
					}
				}
				end_war_effect = yes
			}
			# End every War in Heaven not working!?
			every_war = {
				limit = {
					is_total_war = yes
					any_war_participant = {
						prev = {
							OR = {
								using_war_goal = { type = wg_war_in_heaven owner = prev }
								using_war_goal = { type = wg_CmtWarInHeaven1 owner = prev }
								using_war_goal = { type = wg_CmtWarInHeaven3 owner = prev }
								using_war_goal = { type = wg_CmtWarInHeaven4 owner = prev }
								using_war_goal = { type = wg_CmtWarInHeaven5 owner = prev }
							}
						}
					}
				}
				# end_war_effect = yes
				every_war_participant = {
					limit = { NOT = { is_same_empire = root } } # don't break the loop
					prev = { remove_war_participant = prev }
				}
			}
		}
		# Conduct War in Heaven cleanup
		if = {
			limit = { NOT = { has_global_flag = war_in_heaven_ended } }
			remove_global_flag = war_in_heaven_ongoing
			set_global_flag = war_in_heaven_ended
			# for reuse
			remove_country_flag = sleepers_awake_first_sleeper
			remove_country_flag = sleepers_awake_ancient_rival
			remove_country_flag = war_in_heaven_timer
			random_federation = {
				limit = { has_federation_flag = non_aligned_league }
				random_member = {
					limit = { is_federation_leader = yes }
					set_country_flag = last_best_hope
				}
				every_member = {
					limit = { is_federation_leader = no }
					leave_alliance = { override_requirements = yes }
				}
				dissolve_federation = yes
			}
			every_playable_country = {
				limit = { is_ai = no }
				country_event = { id = war_in_heaven.18 }
			}
			observer_event = { id = observer.80 }
		}
	}
}
