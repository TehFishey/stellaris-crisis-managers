namespace = CrisisManagerMenu
#####################################
#####################################
#####							#####
#####	Crisis Manager			#####
#####							#####
#####	Initializing Events		#####
#####							#####
#####################################
#####################################
### Activation on Game Start
event = {
	id = CrisisManagerMenu.0001
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		CmtEffectSetDetectedEdition = yes
		## Initializing Variables
		if = { limit = { is_scope_type = country is_country_type = global_event }
			country_event = { id = CrisisManagerMenu.0021 }
			# log="Game started global_event"
		} else_if = { limit = { exists = event_target:global_event_country }
			event_target:global_event_country = { country_event = { id = CrisisManagerMenu.0021 } }
			# log="Game started global_event_country"
		} else = {
			random_country = { limit = { is_country_type = global_event }
				country_event = { id = CrisisManagerMenu.0021 }
			}
		}
		## Main Menu
		if = {
			limit = {
				NOR = {
					has_global_flag = CmtFlagNoCall
					any_playable_country = { is_ai = no has_country_flag = CmtFlagNowInMenu }
				}
			}
			if = { limit = { is_scope_type = country is_ai = no }
				if = {
					limit = { NOT = { has_active_event = { CrisisManagerMenu.0100 } } }
					country_event = { id = CrisisManagerMenu.0100 }
				}
			} else = {
				random_playable_country = {
					limit = {
						is_ai = no
						NOT = { has_active_event = { CrisisManagerMenu.0100 } }
					}
					country_event = { id = CrisisManagerMenu.0100 }
				}
			}
			# log="Cmt Game started 1 without CmtFlagNoCall"
		}
		# log="Cmt Game started 1"
	}
}

### Activation for Saved Game
event = {
	id = CrisisManagerMenu.0002
	hide_window = yes
	is_triggered_only = yes
	# Dayly MTTH for fire_only_once event is a big waste of performance, but there is still no other way.
	trigger = {
		NOT = { has_global_flag = CmtFlagActivated }
		# is_country_type = global_event
	}
	immediate = {
		CmtEffectSetDetectedEdition = yes
		if = {
			limit = { CmtTriggerAnyManagedEventTriggered = yes }
			every_playable_country = {
				limit = { NOR = { is_ai = yes has_active_event = { CrisisManagerMenu.0012 } } }
				country_event = { id = CrisisManagerMenu.0012 }		## Warning: Crisis Happened Already
			}
		} else = {
			event_target:global_event_country = {
				country_event = { id = CrisisManagerMenu.0021 }		## Initializing Variables
			}
			random_playable_country = {
				limit = { NOR = { is_ai = yes has_active_event = { CrisisManagerMenu.0011 } } }
				country_event = { id = CrisisManagerMenu.0011 }		## Activating Notification
			}
		}
		# log="Cmt Save loaded 2" # \\[This.GetName]
	}
}

### Manual Call Up (Called from 'Mod Menu')
country_event = {
	id = CrisisManagerMenu.0003	# Same as CrisisManagerMenu.3
	hide_window = yes
	is_triggered_only = yes
	trigger = { is_ai = no }
	immediate = {
		if = {
			limit = { has_country_flag = CmtFlagNowInMenu }
			remove_country_flag = CmtFlagNowInMenu
		}
		if = {
			limit = {
				NOT = { has_active_event = { CrisisManagerMenu.0013 } }
				any_playable_country = { is_ai = no has_country_flag = CmtFlagNowInMenu }
			}
			country_event = { id = CrisisManagerMenu.0013 }
		} else_if = {
			limit = {
				NOR = {
					is_ai = yes
					has_active_event = { CrisisManagerMenu.0100 }
				}
			}
			country_event = { id = CrisisManagerMenu.0100 }
		}
	}
}

### Activating Notification (for only in-game install)
country_event = {
	id = CrisisManagerMenu.0011
	title = CrisisManagerMenu.0011.name
	desc = CrisisManagerMenu.0011.desc
	picture = GFX_evt_CmtMenuA
	is_triggered_only = yes
	option = {
		name = CmtTextOK.name
		custom_tooltip = CmtTextOK.tooltip
		hidden_effect = { CmtEffectExitMenu = yes }
	}
	after = {
		hidden_effect = {
			if = {
				limit = {
					NOR = {
						has_global_flag = CmtFlagNoCall
						has_country_flag = CmtFlagNowInMenu
						has_active_event = { CrisisManagerMenu.0100 }
					}
				}
				country_event = { id = CrisisManagerMenu.0100 }
			}
		}
	}
}

### Error: Crisis Happened Already (for only in-game install)
country_event = {
	id = CrisisManagerMenu.0012
	title = CrisisManagerMenu.0012.name
	desc = CrisisManagerMenu.0012.desc
	picture = GFX_evt_nuclear_explosion
	is_triggered_only = yes
	option = {
		name = CmtTextOK.name
		custom_tooltip = CmtTextOK.tooltip
		hidden_effect = { CmtEffectExitMenu = yes }
	}
}

### Caution: Someone Opening Menu (for Manual Callup)
country_event = {
	id = CrisisManagerMenu.0013
	title = CrisisManagerMenu.0013.name
	desc = CrisisManagerMenu.0013.desc
	picture = GFX_evt_galactic_senate
	is_triggered_only = yes
	trigger = {
		is_ai = no
		any_playable_country = { is_ai = no has_country_flag = CmtFlagNowInMenu }
	}
	option = {
		name = CmtTextOK.name
		custom_tooltip = CmtTextOK.tooltip
	}
	option = {
		name = CrisisManagerMenu.0013b.name
		custom_tooltip = CrisisManagerMenu.0013b.tooltip
		hidden_effect = {
			if = {
				limit = {
					NOT = { has_active_event = { CrisisManagerMenu.0100 } }
				}
				country_event = { id = CrisisManagerMenu.0100 }
			}
		}
	}
}

### Warning: Do Not Advance Time.
country_event = {
	id = CrisisManagerMenu.0014
	title = CrisisManagerMenu.0014.name
	desc = CrisisManagerMenu.0014.desc
	picture = GFX_evt_galactic_senate
	is_triggered_only = yes	# no?
	trigger = {
		has_country_flag = CmtFlagNowInMenu
		NOT = { has_country_flag = CmtFlagNeverWarn14 }
		is_ai = no
	}
	option = {
		name = CmtTextOK.name
		custom_tooltip = CmtTextOK.tooltip
	}
	option = {
		name = CrisisManagerMenu.0014b.name
		custom_tooltip = CrisisManagerMenu.0014b.tooltip
		hidden_effect = { set_country_flag = CmtFlagNeverWarn14 }
	}
}

### Initializing Variables & Flags
country_event = {
	id = CrisisManagerMenu.0021
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_country_type = global_event
	}
	immediate = {
		set_global_flag = CmtFlagActivated
		save_global_event_target_as = CmtGlobalVar
		CmtEffectHardCoatedSettings = yes
		# country_event = { id = CrisisManagerControl.9011 }	## For only debugging
		country_event = { id = CrisisManagerMenu.2000 }			## Apply Vanilla Template
		country_event = { id = CrisisManagerMenu.2001 }			## Auto apply of Template
		if = {
			limit = {
				always = @CmtT201_ConstSleeperFleet_ApplyOnStart
				has_global_flag = CmtFlagSleeperEdition
			}
			CmtEffectApplyTemplate201 = yes						## Apply Template for Initialization for Fleets of Sleepers.
		}
		# TODO outsource?
		# Dyn. L-Gate clue req counter.
		switch = {
			trigger = galaxy_size
			tiny = { change_variable = { which = CmtVarLgateReqClues value = -2 } }
			small = { change_variable = { which = CmtVarLgateReqClues value = -1 } }
			large = { change_variable = { which = CmtVarLgateReqClues value = 1 } }
			huge = { change_variable = { which = CmtVarLgateReqClues value = 2 } }
		}
		# Dyn. CybrexLimit for fleet comp.
		if = { limit = { is_variable_set = CmtVarCybrexResurfacing }
			if = { limit = { check_variable = { which = CmtVarCybrexResurfacing value = 5 } }
				set_variable = { which = CmtVarGrayGooCybrexLimit value = 30 }
			} else_if = { limit = { check_variable = { which = CmtVarCybrexResurfacing value = 4 } }
				set_variable = { which = CmtVarGrayGooCybrexLimit value = 38 }
			} else_if = { limit = { check_variable = { which = CmtVarCybrexResurfacing value = 3 } }
				set_variable = { which = CmtVarGrayGooCybrexLimit value = 66 }
			} else_if = { limit = { check_variable = { which = CmtVarCybrexResurfacing value = 2 } }
				set_variable = { which = CmtVarGrayGooCybrexLimit value = 110 }
			}
		}
	}
}

### Redirect from Console Command
country_event = {
	id = CrisisManagerMenu.0900
	hide_window = yes
	is_triggered_only = yes
	trigger = { is_ai = no }
	immediate = {
		country_event = { id = CrisisManagerMenu.0003 }
	}
}
